(()=>{"use strict";(()=>{const e=(e,t)=>Math.floor(Math.random()*(t-e+1))+e,t=document.querySelector(".map");window.main={getRandomNumber:e,getRandomValueFromArray:t=>t[e(0,t.length-1)],map:t,disableItems:e=>{for(let t=0;t<e.length;t++)e[t].setAttribute("disabled","")},enableItems:e=>{for(let t=0;t<e.length;t++)e[t].removeAttribute("disabled","")},getNoun:(e,t,n,o)=>(e=Math.abs(e),(e%=100)>=5&&e<=20?e+o:1==(e%=10)?e+t:e>=2&&e<=4?e+n:e+o),Key:{ESCAPE:"Escape",ENTER:"Enter"}}})(),(()=>{const e=document.querySelector("#card").content.querySelector(".map__card"),t=window.main.map.querySelector(".map__filters-container"),n={flat:{ru:"Квартира",minPrice:"1000"},bungalow:{ru:"Бунгало",minPrice:"0"},house:{ru:"Дом",minPrice:"5000"},palace:{ru:"Дворец",minPrice:"10000"}},o=()=>{let e=window.main.map.querySelector(".map__card");if(e){let t=e.querySelector(".popup__close");e.remove(),t.removeEventListener("click",o),document.removeEventListener("keydown",r)}},r=e=>{e.key===window.main.Key.ESCAPE&&o()};window.card={renderCard:i=>{t.insertAdjacentElement("beforebegin",(t=>{let i=e.cloneNode(!0),a=i.querySelector(".popup__close");i.querySelector(".popup__title").textContent=t.offer.title,i.querySelector(".popup__text--address").textContent=t.offer.address,i.querySelector(".popup__text--price").textContent=t.offer.price+"₽/ночь",i.querySelector(".popup__type").textContent=n[t.offer.type].ru,i.querySelector(".popup__text--capacity").textContent=`${window.main.getNoun(t.offer.rooms," комната для"," комнаты для "," комнат для ")}${window.main.getNoun(t.offer.guests," гостя "," гостей "," гостей ")}`,i.querySelector(".popup__text--time").textContent=`Заезд после ${t.offer.checkin}, выезд до ${t.offer.checkout}`;let d=i.querySelectorAll(".popup__feature");for(let e=0;e<d.length;e++)d[e].indexOf===t.offer.features[e]&&d[e].remove();i.querySelector(".popup__description").textContent=t.offer.description;let l=i.querySelector(".popup__photos"),m=l.querySelector("img");if(t.offer.photos.length>0){m.src=t.offer.photos[0];for(let e=1;e<t.offer.photos.length;e++){let n=m.cloneNode(!0);n.src=t.offer.photos[e],l.appendChild(n)}}else m.remove();return i.querySelector(".popup__avatar").setAttribute("src",t.author.avatar),a.addEventListener("click",o),document.addEventListener("keydown",r),i})(i))},typesOffers:n,cardRemoveHandler:o}})(),(()=>{const e=document.querySelector("#housing-type"),t=document.querySelector("#housing-price"),n=document.querySelector("#housing-rooms"),o=document.querySelector("#housing-guests");let r={low:{min:0,max:9999},middle:{min:1e4,max:49999},high:{min:5e4,max:1/0}};const i=(e,t)=>"any"===t.value||e.toString()===t.value,a=e=>{let t=document.querySelectorAll(".map__checkbox:checked");return Array.from(t).every((t=>e.indexOf(t.value)>=0))};window.filter={filterData:d=>{let l=[];for(let c=0;c<d.length&&(i(d[c].offer.type,e)&&(m=d[c].offer.price,"any"===(s=t).value||m>=r[s.value].min&&m<=r[s.value].max)&&i(d[c].offer.rooms,n)&&i(d[c].offer.guests,o)&&a(d[c].offer.features)&&l.push(d[c]),5!==l.length);c++);var m,s;return l}}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin"),t=document.querySelector(".map__pins"),n=e=>{window.card.cardRemoveHandler(),window.card.renderCard(e)};window.pin={renderPins:o=>{let r=document.createDocumentFragment();window.filter.filterData(o).slice(0,5).forEach((t=>{r.appendChild((t=>{let o=e.cloneNode(!0);return o.style=`left: ${t.location.x+50}px; top: ${t.location.y+70}px`,o.querySelector("img").src=t.author.avatar,o.querySelector("img").alt=t.offer.title,o.addEventListener("click",(()=>{n(t)})),o.addEventListener("keydown",(e=>{e.key===window.main.Key.ENTER&&n(t)})),o})(t))})),t.appendChild(r)},PIN_X_OFFSET:50,PIN_Y_OFFSET:70}})(),(()=>{let e=document.querySelector("main");const t=()=>{document.querySelector(".success").remove(),document.removeEventListener("keydown",o),document.removeEventListener("click",n)},n=()=>{t()},o=e=>{e.key===window.main.Key.ESCAPE&&t()},r=()=>{document.querySelector(".error").remove(),document.removeEventListener("keydown",d),document.removeEventListener("click",a),document.removeEventListener("click",i)},i=()=>{r()},a=()=>{r()},d=e=>{e.key===window.main.Key.ESCAPE&&r()};window.message={submitSuccessHandler:()=>{let t=document.querySelector("#success").content.querySelector(".success").cloneNode(!0);e.insertAdjacentElement("afterbegin",t),document.addEventListener("keydown",o),document.addEventListener("click",n)},errorHandler:t=>{let n=document.querySelector("#error").content.querySelector(".error").cloneNode(!0);n.querySelector(".error__message").textContent=t,n.querySelector(".error__button").addEventListener("click",i),e.insertAdjacentElement("afterbegin",n),document.addEventListener("keydown",d),document.addEventListener("click",a)}}})(),window.backend={load:(e,t,n)=>{const o=new XMLHttpRequest;o.responseType="json",o.timeout=1e4,o.addEventListener("load",(()=>{switch(o.status){case 200:e(o.response);break;case 400:t("Неверный запрос");break;case 404:t("Ничего не найдено");break;default:t(`Cтатус ответа: ${o.status} ${o.statusText}`)}})),o.addEventListener("error",(()=>{t("Произошла ошибка соединения")})),o.addEventListener("timeout",(()=>{t(`Запрос не успел выполниться за ${o.timeout}мс`)})),n?(o.open("POST","https://21.javascript.pages.academy/keksobooking"),o.send(n)):(o.open("GET","https://21.javascript.pages.academy/keksobooking/data"),o.send())}},(()=>{const e=["gif","jpg","jpeg","png"],t=70,n="Фотография жилья";let o=document.querySelector(".ad-form-header__preview img"),r=document.querySelector(".ad-form__photo");const i=function(t,n){let o=t.target.files[0],r=o.name.toLowerCase();if(e.some((function(e){return r.endsWith(e)}))){let e=new FileReader;e.addEventListener("load",(function(){n.src=e.result})),e.readAsDataURL(o)}};window.preview={loadAvatarHandler:function(e){i(e,o)},loadPhotosHandler:function(e){let o=document.createElement("img");o.width=t,o.height=t,o.alt=n,r.appendChild(o),i(e,o)},resetPreviews:function(){o.src="img/muffin-grey.svg",r.textContent=""}}})(),(()=>{const e=document.querySelector(".map__pin--main"),t=document.querySelector(".ad-form"),n=t.querySelector(".ad-form-header__input"),o=t.querySelector(".ad-form__input"),r=document.querySelectorAll(".map__filter, fieldset"),i=document.querySelector(".map__filters"),a=t.querySelector(".ad-form__reset"),d=t.querySelector("#address"),l=t.querySelector("#room_number"),m=t.querySelector("#capacity"),s=t.querySelector("#type"),c=t.querySelector("#price"),u=t.querySelector("#timein"),w=t.querySelector("#timeout"),p=t=>{let n,o;return t?(n=parseInt(e.style.left,10)+Math.round(e.offsetWidth/2),o=parseInt(e.style.top,10)+Math.round(e.offsetHeight/2)):(n=parseInt(e.style.left,10)+Math.round(window.pin.PIN_X_OFFSET/2),o=parseInt(e.style.top,10)+window.pin.PIN_Y_OFFSET),d.value=`${n}, ${o}`};let f=[1,2,3];const v=()=>{"1"===l.value&&"1"!==m.value?m.setCustomValidity("1 комната для 1-го гостя"):"2"===l.value&&(m.value>f[1]||"0"===m.value)?m.setCustomValidity("2 комнаты для 1-го или 2-х гостей"):"3"===l.value&&m.value<f[0]?m.setCustomValidity("3 комнаты для 1-го, 2-х или 3-х гостей"):l.value>f[2]&&"0"!==m.value?m.setCustomValidity("100 комнат не для гостей"):m.setCustomValidity("")},y=()=>{let e=s.value;c.placeholder=window.card.typesOffers[e].minPrice,c.min=window.card.typesOffers[e].minPrice},_=()=>{window.main.map.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}))},S=()=>{window.main.map.classList.add("map--faded"),t.classList.add("ad-form--disabled"),window.main.disableItems(r),E(),t.removeEventListener("submit",g),a.removeEventListener("click",h),n.removeEventListener("change",window.preview.loadAvatarHandler),o.removeEventListener("change",window.preview.loadPhotosHandler)},E=()=>{e.style.left="570px",e.style.top="375px",p(!0)},h=()=>{t.reset(),i.reset(),window.card.cardRemoveHandler(),S(),_(),window.preview.resetPreviews()},g=e=>{e.preventDefault(),window.backend.load(window.message.submitSuccessHandler,window.message.errorHandler,new FormData(t)),h()};window.form={mapPinMain:e,adForm:t,avatarSelection:n,previewSelection:o,mapFilters:i,fieldTimeIn:u,fieldTimeOut:w,setAddress:p,validateRooms:v,validateMinPrice:y,fieldTypeChangeHandler:()=>{y()},fieldRoomNumberChangeHandler:()=>{v()},fieldTimeInChangeHandler:()=>{u.value=w.value},fieldTimeOutChangeHandler:()=>{w.value=u.value},submitFormHandler:g,formElements:r,adFormReset:a,removePins:_,deactivateMap:S,resetPage:h}})(),window.move={moveMainPin:e=>{let t={x:e.clientX,y:e.clientY};const n=e=>{e.preventDefault();let n=0-window.pin.PIN_X_OFFSET/2,o=1200-window.pin.PIN_X_OFFSET/2,r=130-window.pin.PIN_Y_OFFSET,i=630-window.pin.PIN_Y_OFFSET,a=t.x-e.clientX,d=t.y-e.clientY;t={x:e.clientX,y:e.clientY},window.form.mapPinMain.style.top=window.form.mapPinMain.offsetTop-d+"px",window.form.mapPinMain.style.left=window.form.mapPinMain.offsetLeft-a+"px",window.form.mapPinMain.offsetLeft<n?window.form.mapPinMain.style.left=n+"px":window.form.mapPinMain.offsetLeft>o&&(window.form.mapPinMain.style.left=o+"px"),window.form.mapPinMain.offsetTop<r?window.form.mapPinMain.style.top=r+"px":window.form.mapPinMain.offsetTop>i&&(window.form.mapPinMain.style.top=i+"px"),window.form.setAddress()},o=e=>{e.preventDefault(),document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",o)};document.addEventListener("mousemove",n),document.addEventListener("mouseup",o)}},window.debounce={debounce:e=>{let t=null;return(...n)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...n)}),500)}}},(()=>{const e=window.debounce.debounce((e=>{window.form.removePins(),window.card.cardRemoveHandler(),window.pin.renderPins(e)})),t=t=>{window.pin.renderPins(t),window.form.mapFilters.addEventListener("change",(()=>{e(t)}))},n=()=>{window.main.map.classList.remove("map--faded"),window.form.adForm.classList.remove("ad-form--disabled"),window.form.adForm.addEventListener("change",window.form.fieldRoomNumberChangeHandler),window.form.adForm.addEventListener("change",window.form.fieldTypeChangeHandler),window.form.fieldTimeIn.addEventListener("change",window.form.fieldTimeOutChangeHandler),window.form.fieldTimeOut.addEventListener("change",window.form.fieldTimeInChangeHandler),window.form.mapPinMain.removeEventListener("keydown",o),window.main.enableItems(window.form.formElements),window.form.setAddress(),window.backend.load(t,window.message.errorHandler),window.form.validateRooms(),window.form.validateMinPrice(),window.form.adForm.addEventListener("submit",window.form.submitFormHandler),window.form.adFormReset.addEventListener("click",window.form.resetPage),window.form.avatarSelection.addEventListener("change",window.preview.loadAvatarHandler),window.form.previewSelection.addEventListener("change",window.preview.loadPhotosHandler)},o=e=>{e.key===window.main.Key.ENTER&&n()};window.form.deactivateMap(),window.form.mapPinMain.addEventListener("mousedown",(e=>{0===e.button&&(e.preventDefault(),window.main.map.classList.contains("map--faded")&&n(),window.move.moveMainPin(e))})),window.form.mapPinMain.addEventListener("keydown",o),window.card.cardRemoveHandler()})()})();